<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="datagrid-icons.html">
<link rel="import" href="radium-datagrid-row.html">
<link rel="import" href="radium-datagrid-column.html">

<!--
A Material Design inspired data grid element for Polymer.js apps.

TODO

@element radium-datagrid
@demo demo/index.html Basic configurations
@demo demo/index2.html Paging footer
@demo demo/index3.html Item selection
@demo demo/index4.html Fixed header
@demo demo/index5.html Infinite scroll
@demo demo/index6.html Infinite scroll 2
@demo demo/index7.html Column Filtering
-->
<dom-module id="radium-datagrid">
  <style>
    #headerRow {
      overflow: hidden;
    }
    #headerRow.scroll-pad {
      margin-right: 15px;
    }
    .colHeader {
      min-height: 56px;
      max-height: 56px;
      line-height: 56px;
    }
    .colHeader[data-sortable] {
      cursor: pointer;
    }
    #list {
      height: calc(100% - 56px);
    }
    .hztl-lines ::content radium-datagrid-column {
      border-bottom-style: solid;
      border-bottom-width: 1px;
      border-bottom-color: var(--grid-line-color,#DDDDDD);
    }
    .vert-lines ::content radium-datagrid-column {
      border-right-style: solid;
      border-right-width: 1px;
      border-right-color: var(--grid-line-color,#DDDDDD);
    }
    .vert-lines ::content radium-datagrid-column:last-of-type {
      border-right: none;
    }
    :host([disable-column-resize]) ::content radium-datagrid-column .splitter {
      display: none;
    }
    :host ::content radium-datagrid-column:first-of-type .splitter {
      display: none;
    }
  </style>
  <template>
    <div id="headerRow" class="horizontal layout">
      <template is="dom-repeat" items="[[_headers]]" as="header">
        <radium-datagrid-column class="colHeader" config="[[header.config]]"
            data-sortable$="[[header.config.sortable]]">
          <iron-icon icon="arrow-forward"></iron-icon>
          <div on-tap="_sortColumn">[[header.config.header]]</div>
        </radium-datagrid-column>
      </template>
    </div>
    <iron-list id="list" items="[[items]]" as="row">
      <content></content>
    </iron-list>
    <content id="template" select="template"></content>
  </template>
</dom-module>
<script>
  (function() {
    Polymer({
      is: 'radium-datagrid',
      properties: {
        _columnWidths: {
          type: Object,
          value: function(){return {};},
        },
        _headers: {
          type: Array,
          value: function(){return null;}
        },
        i18nFunction: {
          type: Function,
          value: null
        },
        items: {
          type: Array,
          value: function(){return null;}
        },
        gridLines: {
          type: String,
          value: 'horizontal'
        },
        disableColumnResize: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
      },
      behaviors: [Polymer.Templatizer],
      observers: [
        '_itemsChanged(items.*)',
        '_gridLinesChanged(gridLines)'
      ],
      _gridLoading: false,
      _itemsChanged: function(change) {
        this._gridLoading = false;
        this._applyColumnWidths();
        this.async(function() {
          this.toggleClass('scroll-pad', (this.$.list.scrollHeight > this.$.list.clientHeight), this.$.headerRow);
        }.bind(this), 1);
      },
      _gridLinesChanged: function() {
        this._updateGridLines(this.$.list);
        this._updateGridLines(this.$.headerRow);
      },
      _updateGridLines: function(node) {
        this.toggleClass('hztl-lines', false, node);
        this.toggleClass('vert-lines', false, node);
        if (this.gridLines.toLowerCase() === 'horizontal' || this.gridLines.toLowerCase() === 'both') {
          this.toggleClass('hztl-lines', true, node);
        }
        if (this.gridLines.toLowerCase() === 'vertical' || this.gridLines.toLowerCase() === 'both') {
          this.toggleClass('vert-lines', true, node);
        }
      },
      _setHeaders: function(row) {
        var columns = row.querySelectorAll('radium-datagrid-column');
        var headers = [];
        for (var i = 0; i < columns.length; i++) {
          var cfg = columns[i]._config;
          cfg.isHeader = true;
          headers.push({config:cfg});
        };
        this._headers = headers;
      },
      _handleHeaderUpdate: function(e,detail) {
        if (e.detail.prop === 'columnWidth') {
          this._columnWidths = {};
        }
        this.$.headerRow.children[detail.index][detail.prop] = e.target[detail.prop];
      },
      _computedTranslate: function(i18n, key, defaultVal) {
        return this._translate(key, defaultVal);
      },
      _translate: function(key, defaultVal) {
        if (this.i18nFunction) {
          return this.i18nFunction(key);
        } else {
          return defaultVal;
        }
      },
      _listScroll: function(e) {
        this.$.headerRow.scrollLeft = this.$.list.scrollLeft;
      },
      _columnResize: function(e) {
        var idx = e.detail.idx;
        var delta = e.detail.delta;
        this._resizeHeaders(idx, delta);
        this._applyColumnWidths();
      },
      _applyColumnWidths: function() {
        Object.keys(this._columnWidths).forEach(function(key) {
          var rows = this.$.list.$.items.querySelectorAll('radium-datagrid-row');
          for (var i = 0; i < rows.length; i++) {
            this._resizeCell(rows[i].children[key], this._columnWidths[key]);
          }
        }.bind(this));
      },
      _resizeHeaders: function(idx, delta) {
        var minColWidth = 48;
        var col = this.$.headerRow.children[idx];
        var colWidth = document.defaultView.getComputedStyle(col, '').getPropertyValue('width');
        var newColWidth = (parseInt(colWidth, 10) - delta);
        var prev = this.$.headerRow.children[idx - 1];
        var prevWidth = document.defaultView.getComputedStyle(prev, '').getPropertyValue('width');
        var newPrevWidth = (parseInt(prevWidth, 10) + delta);
        if (newColWidth > minColWidth && newPrevWidth > minColWidth) {
          this._columnWidths[idx] = newColWidth;
          this._columnWidths[idx-1] = newPrevWidth;
          this._resizeCell(col, newColWidth);
          this._resizeCell(prev, newPrevWidth);
        }
      },
      _resizeCell: function(cell, width) {
        cell.style['min-width'] = width + 'px';
        cell.style['max-width'] = width + 'px';
        cell.style.flex = 'initial';
      },
      setLoading: function() {
        this.items = null;
        this._gridLoading = true;
      },
      _boundScrollListener: null,
      attached: function() {
        this._boundScrollListener = this._listScroll.bind(this);
        this.$.list.addEventListener('scroll', this._boundScrollListener);
      },
      detached: function() {
        this.$.list.removeEventListener('scroll', this._boundScrollListener);
      },
      ready: function() {
        this.listen(this, 'update-header', '_handleHeaderUpdate');
        this.listen(this, 'column-resize', '_columnResize');
      }
    });
  })();
</script>
